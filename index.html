<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>頭痛日記 - 整合版</title>
    <link rel="apple-touch-icon" href="header-bg.png">
    <link rel="icon" href="header-bg.png">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: #f0f8ff; 
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #ffffff;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            overflow-x: hidden;
        }
        /* 優化後的 Tab 樣式 */
        .glass-tab {
            /* 改為深色半透明底，讓白色 ICON 在淺色背景圖上更明顯 */
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            color: white; /* 強制白色 ICON */
        }
        .active-tab {
            background: rgba(255, 255, 255, 0.95);
            color: #2563EB; /* 更深的藍色，增加對比 */
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); /* 藍色光暈 */
            transform: translateY(-2px);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soft-blue': '#E0F2F1',
                        'cinn-blue': '#4A90E2',
                    }
                }
            }
        }
    </script>
</head>
<body>

<div id="app" class="app-container bg-slate-50">
    
    <header class="relative w-full h-[250px] overflow-hidden">
        <img src="./banner.jpg" alt="Header Banner" class="w-full h-full object-cover object-center">
        
        <div class="absolute bottom-6 right-4 flex gap-3 z-20">
            <button @click="currentTab = 'headache'" :class="['p-3 w-12 h-12 flex items-center justify-center transition-all duration-300 rounded-xl', currentTab === 'headache' ? 'active-tab scale-110' : 'glass-tab hover:bg-black/40']">
                <i class="fa-solid fa-pen text-xl"></i>
            </button>
            <button @click="currentTab = 'exercise'" :class="['p-3 w-12 h-12 flex items-center justify-center transition-all duration-300 rounded-xl', currentTab === 'exercise' ? 'active-tab scale-110' : 'glass-tab hover:bg-black/40']">
                <i class="fa-solid fa-person-running text-xl"></i>
            </button>
            <button @click="currentTab = 'period'" :class="['p-3 w-12 h-12 flex items-center justify-center transition-all duration-300 rounded-xl', currentTab === 'period' ? 'active-tab scale-110' : 'glass-tab hover:bg-black/40']">
                <i class="fa-solid fa-droplet text-xl"></i>
            </button>
            <button @click="currentTab = 'summary'" :class="['p-3 w-12 h-12 flex items-center justify-center transition-all duration-300 rounded-xl', currentTab === 'summary' ? 'active-tab scale-110' : 'glass-tab hover:bg-black/40']">
                <i class="fa-solid fa-calendar-days text-xl"></i>
            </button>
        </div>
    </header>

    <main class="relative -mt-6 bg-white rounded-t-3xl min-h-[600px] shadow-[0_-5px_15px_rgba(0,0,0,0.05)] pt-8 pb-24 px-5 z-10">

        <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center border-b-2 border-soft-blue inline-block pb-1 px-4 mx-auto block w-fit">
            {{ getTabTitle }}
        </h2>

        <div v-if="currentTab === 'headache'" class="space-y-4">
            <div v-if="headacheRecords.length === 0" class="text-center text-gray-400 py-10">
                <i class="fa-solid fa-face-smile text-4xl mb-2"></i>
                <p>目前沒有頭痛紀錄</p>
            </div>
            
            <div v-for="(record, index) in headacheRecords" :key="record.id" class="bg-blue-50 p-4 rounded-2xl shadow-sm border border-blue-100 relative group">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <span class="bg-white text-cinn-blue text-xs font-bold px-2 py-1 rounded-full shadow-sm">
                            {{ record.period }} {{ record.time }}
                        </span>
                        <span v-if="record.hasMeds" class="bg-emerald-100 text-emerald-600 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">
                            <i class="fa-solid fa-pills"></i> 已投藥
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button v-if="index > 0" @click="moveRecord('headache', index, -1)" class="text-gray-300 hover:text-gray-500"><i class="fa-solid fa-chevron-up"></i></button>
                        <button v-if="index < headacheRecords.length - 1" @click="moveRecord('headache', index, 1)" class="text-gray-300 hover:text-gray-500"><i class="fa-solid fa-chevron-down"></i></button>
                        <button @click="editRecord('headache', record)" class="text-gray-400 hover:text-blue-500"><i class="fa-solid fa-pen-to-square"></i></button>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-gray-600 text-sm">疼痛程度：</span>
                    <div class="flex gap-1">
                        <div v-for="n in 3" :key="n" :class="['w-3 h-3 rounded-full', n <= record.intensity ? (record.intensity === 3 ? 'bg-red-400' : 'bg-blue-400') : 'bg-gray-200']"></div>
                    </div>
                    <span class="text-xs text-gray-500">({{ getIntensityLabel(record.intensity) }})</span>
                </div>

                <div class="flex flex-wrap gap-1 mb-2">
                    <span v-for="sym in record.symptoms" class="text-xs bg-white text-gray-600 px-2 py-1 rounded border border-gray-100">
                        {{ sym }}
                    </span>
                </div>

                <div v-if="record.hasMeds" class="mt-3 pt-2 border-t border-blue-100 text-sm text-gray-600 bg-blue-100/30 p-2 rounded-lg">
                    <div class="font-bold text-emerald-600 mb-1">
                        <i class="fa-solid fa-prescription-bottle-medical mr-1"></i>
                        {{ record.medNames.join(', ') }}
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>服用時間: {{ record.medTime }}</span>
                        <span class="font-medium text-emerald-600">效果: {{ record.medReaction }}</span>
                    </div>
                </div>
            </div>

            <button @click="openModal('headache')" class="fixed bottom-8 right-6 w-14 h-14 bg-cinn-blue text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition-transform z-50">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-if="currentTab === 'exercise'" class="space-y-4">
            <div v-if="exerciseRecords.length === 0" class="text-center text-gray-400 py-10">
                <p>還沒運動喔！</p>
            </div>
            <div v-for="record in exerciseRecords" :key="record.id" class="bg-orange-50 p-4 rounded-2xl shadow-sm border border-orange-100 flex justify-between items-center">
                <div>
                    <div class="text-xl font-bold text-gray-700">{{ record.item }}</div>
                    <div class="text-gray-500 text-sm mt-1"><i class="fa-regular fa-clock mr-1"></i>{{ record.time }}</div>
                </div>
                <button @click="deleteItem('exercise', record.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
            </div>
            <button @click="openModal('exercise')" class="fixed bottom-8 right-6 w-14 h-14 bg-orange-400 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition-transform z-50">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-if="currentTab === 'period'" class="space-y-4">
             <div v-if="periodRecords.length === 0" class="text-center text-gray-400 py-10">
                <p>新增經期紀錄</p>
            </div>
            <div v-for="record in periodRecords" :key="record.id" class="bg-rose-50 p-4 rounded-2xl shadow-sm border border-rose-100 flex justify-between items-center">
                <div>
                    <div class="text-rose-600 font-bold"><i class="fa-solid fa-droplet mr-2"></i>經期</div>
                    <div class="text-gray-700 mt-1">{{ record.startDate }} ~ {{ record.endDate }}</div>
                </div>
                <button @click="deleteItem('period', record.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
            </div>
            <button @click="openModal('period')" class="fixed bottom-8 right-6 w-14 h-14 bg-rose-400 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition-transform z-50">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div v-if="currentTab === 'summary'" class="space-y-6">
            <div class="bg-white border-2 border-dashed border-gray-200 rounded-xl p-5 text-gray-600">
                <h3 class="text-lg font-bold text-cinn-blue mb-4 border-l-4 border-cinn-blue pl-2">本月醫師報告摘要</h3>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-50 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-500">頭痛總次數</div>
                        <div class="text-2xl font-bold text-gray-700">{{ summaryData.totalDays }} <span class="text-xs font-normal">次</span></div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-500">最痛等級</div>
                        <div class="text-2xl font-bold text-red-400">{{ summaryData.maxPain }}</div>
                    </div>
                </div>

                <div class="space-y-2 text-sm">
                    <p><strong><i class="fa-solid fa-chart-simple mr-2 text-blue-400"></i>疼痛分級統計：</strong></p>
                    <ul class="list-disc pl-8 space-y-1">
                        <li>輕度 (1級)：{{ summaryData.level1 }} 次</li>
                        <li>中度 (2級)：{{ summaryData.level2 }} 次</li>
                        <li>重度 (3級)：{{ summaryData.level3 }} 次</li>
                    </ul>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-100 space-y-2 text-sm">
                     <p><strong><i class="fa-solid fa-pills mr-2 text-green-400"></i>投藥次數：</strong> {{ summaryData.medCount }} 次</p>
                     <p><strong><i class="fa-solid fa-person-running mr-2 text-orange-400"></i>運動天數：</strong> {{ exerciseRecords.length }} 天</p>
                     <p><strong><i class="fa-solid fa-droplet mr-2 text-rose-400"></i>最近經期：</strong> {{ periodRecords.length > 0 ? periodRecords[0].startDate : '無紀錄' }}</p>
                </div>
            </div>
            <p class="text-center text-xs text-gray-400">此報表依據當月紀錄自動生成</p>
        </div>

    </main>

    <div v-if="isModalOpen" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-700 mb-4">{{ isEditing ? '編輯紀錄' : '新增紀錄' }}</h3>
            
            <div v-if="modalType === 'headache'" class="space-y-4">
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">時段</label>
                        <select v-model="form.period" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm">
                            <option value="早">早</option>
                            <option value="中">中</option>
                            <option value="晚">晚</option>
                            <option value="睡覺">睡覺</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">發生時間</label>
                        <input type="time" v-model="form.time" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-gray-500 mb-1">疼痛程度 (1-3)</label>
                    <select v-model="form.intensity" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm">
                        <option :value="1">1 - 輕微</option>
                        <option :value="2">2 - 中度</option>
                        <option :value="3">3 - 重度 (無法忍受)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs text-gray-500 mb-1">症狀 (可複選)</label>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center space-x-2"><input type="checkbox" value="對光敏感" v-model="form.symptoms"><span>對光敏感</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="對聲音敏感" v-model="form.symptoms"><span>對聲音敏感</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="單側開始" v-model="form.symptoms"><span>單側開始</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="搏動性" v-model="form.symptoms"><span>搏動性</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="噁心" v-model="form.symptoms"><span>噁心</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="嘔吐" v-model="form.symptoms"><span>嘔吐</span></label>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <label class="flex items-center space-x-2 mb-3 cursor-pointer">
                        <input type="checkbox" v-model="form.hasMeds" class="w-5 h-5 text-cinn-blue rounded border-gray-300 focus:ring-cinn-blue">
                        <span class="font-bold text-gray-700">本次有服用藥物嗎？</span>
                    </label>

                    <div v-if="form.hasMeds" class="bg-green-50 p-3 rounded-lg border border-green-100 space-y-3 animate-fade-in">
                        <div>
                            <label class="block text-xs text-green-700 mb-1">藥物種類</label>
                            <div class="space-y-1 text-sm">
                                <label class="flex items-center space-x-2"><input type="checkbox" value="Imigran" v-model="form.medNames"><span>Imigran</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" value="Rizatan" v-model="form.medNames"><span>Rizatan</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" value="Diclofenac" v-model="form.medNames"><span>Diclofenac</span></label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-green-700 mb-1">服用時間</label>
                                <input type="time" v-model="form.medTime" class="w-full bg-white border border-green-200 rounded p-1 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-green-700 mb-1">效果</label>
                                <select v-model="form.medReaction" class="w-full bg-white border border-green-200 rounded p-1 text-sm">
                                    <option value="沒效">沒效</option>
                                    <option value="有效">有效</option>
                                    <option value="完全不痛">完全不痛</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="modalType === 'exercise'" class="space-y-3">
                <label class="block text-sm text-gray-600">運動項目</label>
                <input type="text" v-model="form.item" placeholder="例如：跑步 3km" class="w-full bg-gray-50 border border-gray-200 rounded p-2">
                <label class="block text-sm text-gray-600">時間</label>
                <input type="time" v-model="form.time" class="w-full bg-gray-50 border border-gray-200 rounded p-2">
            </div>

            <div v-if="modalType === 'period'" class="space-y-3">
                <label class="block text-sm text-gray-600">開始日期</label>
                <input type="date" v-model="form.startDate" class="w-full bg-gray-50 border border-gray-200 rounded p-2">
                <label class="block text-sm text-gray-600">結束日期</label>
                <input type="date" v-model="form.endDate" class="w-full bg-gray-50 border border-gray-200 rounded p-2">
            </div>

            <div class="mt-8 flex gap-3">
                <button @click="isModalOpen = false" class="flex-1 py-2 rounded-lg border border-gray-300 text-gray-500 hover:bg-gray-50">取消</button>
                <button @click="saveRecord" class="flex-1 py-2 rounded-lg bg-cinn-blue text-white shadow-md hover:bg-blue-600">儲存</button>
            </div>
            
            <button v-if="isEditing" @click="deleteConfirm" class="w-full mt-3 py-2 text-red-400 text-sm hover:underline">刪除此紀錄</button>

        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, reactive } = Vue;

    createApp({
        setup() {
            const currentTab = ref('headache');
            const isModalOpen = ref(false);
            const isEditing = ref(false);
            const modalType = ref('');
            const editingId = ref(null);

            // 資料儲存 (新增了 med 相關欄位到 headacheRecords)
            const headacheRecords = ref([
                { 
                    id: 1, 
                    period: '晚', 
                    time: '20:30', 
                    intensity: 2, 
                    symptoms: ['對光敏感', '噁心'],
                    hasMeds: true,
                    medNames: ['Imigran'],
                    medTime: '20:45',
                    medReaction: '有效'
                },
                { 
                    id: 2, 
                    period: '睡覺', 
                    time: '23:00', 
                    intensity: 1, 
                    symptoms: ['單側開始'],
                    hasMeds: false,
                    medNames: [],
                    medTime: '',
                    medReaction: ''
                }
            ]);
            
            const exerciseRecords = ref([]);
            const periodRecords = ref([]);

            // 表單模型 (包含合併後的欄位)
            const form = reactive({
                // 頭痛欄位
                period: '早', time: '', intensity: 1, symptoms: [],
                // 投藥欄位 (整合)
                hasMeds: false, medNames: [], medTime: '', medReaction: '有效',
                // 其他
                item: '', startDate: '', endDate: ''
            });

            // 標題計算
            const getTabTitle = computed(() => {
                const titles = {
                    'headache': '頭痛與用藥紀錄',
                    'exercise': '運動紀錄',
                    'period': '生理期紀錄',
                    'summary': '本月健康統整'
                };
                return titles[currentTab.value];
            });

            // 統計邏輯 (更新)
            const summaryData = computed(() => {
                const level1 = headacheRecords.value.filter(r => r.intensity === 1).length;
                const level2 = headacheRecords.value.filter(r => r.intensity === 2).length;
                const level3 = headacheRecords.value.filter(r => r.intensity === 3).length;
                const maxPain = Math.max(0, ...headacheRecords.value.map(r => r.intensity));
                
                // 計算吃藥次數 (根據 hasMeds 屬性)
                const medCount = headacheRecords.value.filter(r => r.hasMeds).length;
                
                return {
                    totalDays: headacheRecords.value.length,
                    level1, level2, level3, medCount,
                    maxPain: maxPain === 0 ? '無' : (maxPain === 1 ? '輕' : (maxPain === 2 ? '中' : '重'))
                };
            });

            // 方法
            const getIntensityLabel = (val) => ['無', '輕', '中', '重'][val];

            const resetForm = () => {
                form.period = '早'; form.time = ''; form.intensity = 1; form.symptoms = [];
                form.hasMeds = false; form.medNames = []; form.medTime = ''; form.medReaction = '有效';
                form.item = '';
                form.startDate = ''; form.endDate = '';
            };

            const openModal = (type) => {
                modalType.value = type;
                isEditing.value = false;
                editingId.value = null;
                resetForm();
                
                // 預設時間
                const now = new Date();
                const timeStr = now.toTimeString().slice(0, 5);
                form.time = timeStr;
                form.medTime = timeStr; // 預設吃藥時間也為當下
                
                isModalOpen.value = true;
            };

            const editRecord = (type, record) => {
                modalType.value = type;
                isEditing.value = true;
                editingId.value = record.id;
                
                // 填入資料 (包含深拷貝避免參照錯誤)
                Object.assign(form, JSON.parse(JSON.stringify(record))); 
                isModalOpen.value = true;
            };

            const saveRecord = () => {
                const data = { ...form }; // Copy
                
                if (isEditing.value) {
                    let targetArray;
                    if (modalType.value === 'headache') targetArray = headacheRecords;
                    if (modalType.value === 'exercise') targetArray = exerciseRecords;
                    if (modalType.value === 'period') targetArray = periodRecords;
                    
                    const idx = targetArray.value.findIndex(r => r.id === editingId.value);
                    if (idx !== -1) targetArray.value[idx] = { ...targetArray.value[idx], ...data };
                } else {
                    data.id = Date.now();
                    if (modalType.value === 'headache') headacheRecords.value.push(data);
                    if (modalType.value === 'exercise') exerciseRecords.value.push(data);
                    if (modalType.value === 'period') periodRecords.value.push(data);
                }
                isModalOpen.value = false;
            };

            const deleteConfirm = () => {
                if(confirm('確定要刪除這筆紀錄嗎？')) {
                    if (modalType.value === 'headache') {
                        headacheRecords.value = headacheRecords.value.filter(r => r.id !== editingId.value);
                    }
                    // 其他類型的刪除邏輯在 deleteItem 處理，這裡是 Modal 內的刪除
                    if (modalType.value === 'exercise') exerciseRecords.value = exerciseRecords.value.filter(r => r.id !== editingId.value);
                    if (modalType.value === 'period') periodRecords.value = periodRecords.value.filter(r => r.id !== editingId.value);
                    
                    isModalOpen.value = false;
                }
            };

            const deleteItem = (type, id) => {
                if(!confirm('確認刪除？')) return;
                if (type === 'exercise') exerciseRecords.value = exerciseRecords.value.filter(r => r.id !== id);
                if (type === 'period') periodRecords.value = periodRecords.value.filter(r => r.id !== id);
            };

            const moveRecord = (type, index, direction) => {
                if (type === 'headache') {
                    const arr = headacheRecords.value;
                    const newIndex = index + direction;
                    if (newIndex >= 0 && newIndex < arr.length) {
                        [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
                    }
                }
            };

            return {
                currentTab, isModalOpen, isEditing, modalType, form,
                headacheRecords, exerciseRecords, periodRecords,
                getTabTitle, summaryData, getIntensityLabel,
                openModal, editRecord, saveRecord, deleteConfirm, deleteItem, moveRecord
            };
        }
    }).mount('#app');
</script>

</body>
</html>