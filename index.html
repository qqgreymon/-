<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>頭痛日記 - 雙人進階統計版</title>
    
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f0f8ff">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: #f0f8ff; 
            overscroll-behavior-y: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #ffffff;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            overflow-x: hidden;
            padding-bottom: 80px;
        }
        .glass-tab {
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            color: white;
        }
        .active-tab {
            background: rgba(255, 255, 255, 0.95);
            color: #2563EB;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
            transform: translateY(-2px);
        }
        .char-btn.active {
            border: 2px solid;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soft-blue': '#E0F2F1',
                        'cinn-blue': '#4A90E2',
                        'stitch-blue': '#1E3A8A', 
                        'stitch-light': '#93C5FD',
                    }
                }
            }
        }
    </script>
</head>
<body>

<div id="app" class="app-container bg-slate-50">
    
    <header class="relative w-full h-[250px] overflow-hidden">
        <img src="./banner.jpg" alt="Header Banner" class="w-full h-full object-cover object-center">
        
        <div class="absolute bottom-6 right-4 flex gap-3 z-20">
            <button @click="currentTab = 'headache'" :class="['p-3 w-12 h-12 flex items-center justify-center transition-all duration-300 rounded-xl', currentTab === 'headache' ? 'active-tab scale-110' : 'glass-tab hover:bg-black/40']">
                <i class="fa-solid fa-pen text-xl"></i>
            </button>
            <button @click="currentTab = 'exercise'" :class="['p-3 w-12 h-12 flex items-center justify-center transition-all duration-300 rounded-xl', currentTab === 'exercise' ? 'active-tab scale-110' : 'glass-tab hover:bg-black/40']">
                <i class="fa-solid fa-person-running text-xl"></i>
            </button>
            <button @click="currentTab = 'period'" :class="['p-3 w-12 h-12 flex items-center justify-center transition-all duration-300 rounded-xl', currentTab === 'period' ? 'active-tab scale-110' : 'glass-tab hover:bg-black/40']">
                <i class="fa-solid fa-droplet text-xl"></i>
            </button>
            <button @click="currentTab = 'summary'" :class="['p-3 w-12 h-12 flex items-center justify-center transition-all duration-300 rounded-xl', currentTab === 'summary' ? 'active-tab scale-110' : 'glass-tab hover:bg-black/40']">
                <i class="fa-solid fa-calendar-days text-xl"></i>
            </button>
        </div>
    </header>

    <main class="relative -mt-6 bg-white rounded-t-3xl min-h-[600px] shadow-[0_-5px_15px_rgba(0,0,0,0.05)] pt-8 px-5 z-10">

        <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center border-b-2 border-soft-blue inline-block pb-1 px-4 mx-auto block w-fit">
            {{ getTabTitle }}
        </h2>

        <div v-if="currentTab === 'headache'" class="space-y-4">
            <div v-if="headacheRecords.length === 0" class="text-center text-gray-400 py-10">
                <i class="fa-solid fa-face-smile text-4xl mb-2"></i>
                <p>目前沒有紀錄</p>
            </div>
            
            <div v-for="(record, index) in sortedHeadacheRecords" :key="record.id" 
                 :class="['p-4 rounded-2xl shadow-sm border relative group overflow-hidden', 
                          record.character === 'stitch' ? 'bg-indigo-50 border-indigo-200' : 'bg-sky-50 border-sky-200']">
                
                <div :class="['absolute left-0 top-0 bottom-0 w-2', record.character === 'stitch' ? 'bg-stitch-blue' : 'bg-sky-400']"></div>

                <div class="flex justify-between items-start mb-2 pl-3">
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span :class="['text-xs font-bold px-2 py-0.5 rounded-full text-white', record.character === 'stitch' ? 'bg-stitch-blue' : 'bg-sky-400']">
                                {{ record.character === 'stitch' ? '史迪奇' : '大耳狗' }}
                            </span>
                            <span class="text-gray-500 text-sm font-medium">{{ record.date }}</span>
                        </div>
                        <span class="text-2xl font-bold text-gray-700 font-mono">{{ record.time }}</span>
                    </div>
                    <button @click="editRecord('headache', record)" class="text-gray-400 hover:text-blue-500 p-1"><i class="fa-solid fa-pen-to-square"></i></button>
                </div>
                
                <div class="pl-3">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-gray-600 text-sm">疼痛：</span>
                        <div class="flex gap-1">
                            <div v-for="n in 3" :key="n" :class="['w-3 h-3 rounded-full', n <= record.intensity ? (record.intensity === 3 ? 'bg-red-400' : (record.character==='stitch'?'bg-indigo-400':'bg-sky-400')) : 'bg-gray-200']"></div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-2">
                        <span v-for="sym in record.symptoms" class="text-xs bg-white text-gray-600 px-2 py-1 rounded border border-gray-100">{{ sym }}</span>
                    </div>
                    <div v-if="record.hasMeds" :class="['mt-3 pt-2 border-t text-sm p-2 rounded-lg', record.character === 'stitch' ? 'border-indigo-100 bg-indigo-100/50' : 'border-sky-100 bg-sky-100/50']">
                        <div class="font-bold text-gray-700 mb-1 flex items-center"><i class="fa-solid fa-pills mr-1"></i>{{ record.medNames.join(', ') }}</div>
                        <div class="flex justify-between text-xs text-gray-500"><span>{{ record.medTime }}</span><span class="font-medium text-emerald-600">{{ record.medReaction }}</span></div>
                    </div>
                </div>
            </div>

            <button @click="openModal('headache')" class="fixed bottom-8 right-6 w-14 h-14 bg-cinn-blue text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition-transform z-50"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentTab === 'exercise'" class="space-y-4">
            <div v-if="exerciseRecords.length === 0" class="text-center text-gray-400 py-10"><p>還沒運動喔！</p></div>
            
            <div v-for="record in sortedExerciseRecords" :key="record.id" 
                 :class="['p-4 rounded-2xl shadow-sm border relative overflow-hidden', 
                          record.character === 'stitch' ? 'bg-indigo-50 border-indigo-200' : 'bg-orange-50 border-orange-200']">
                
                <div :class="['absolute left-0 top-0 bottom-0 w-2', record.character === 'stitch' ? 'bg-stitch-blue' : 'bg-orange-400']"></div>
                
                <div class="pl-3 flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span :class="['text-xs font-bold px-2 py-0.5 rounded-full text-white', record.character === 'stitch' ? 'bg-stitch-blue' : 'bg-orange-400']">
                                {{ record.character === 'stitch' ? '史迪奇' : '大耳狗' }}
                            </span>
                            <span class="text-xs text-gray-500">{{ record.date }}</span>
                        </div>
                        <div class="text-xl font-bold text-gray-700">{{ record.item }}</div>
                        <div class="text-gray-500 text-sm mt-1"><i class="fa-regular fa-clock mr-1"></i>{{ record.time }}</div>
                    </div>
                    <button @click="deleteItem('exercise', record.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <button @click="openModal('exercise')" class="fixed bottom-8 right-6 w-14 h-14 bg-orange-400 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition-transform z-50"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentTab === 'period'" class="space-y-4">
             <div v-if="periodRecords.length === 0" class="text-center text-gray-400 py-10"><p>新增經期紀錄</p></div>
            
            <div v-for="record in sortedPeriodRecords" :key="record.id" 
                 :class="['p-4 rounded-2xl shadow-sm border relative overflow-hidden', 
                          record.character === 'stitch' ? 'bg-indigo-50 border-indigo-200' : 'bg-rose-50 border-rose-200']">
                
                <div :class="['absolute left-0 top-0 bottom-0 w-2', record.character === 'stitch' ? 'bg-stitch-blue' : 'bg-rose-400']"></div>
                
                <div class="pl-3 flex justify-between items-center">
                    <div>
                         <div class="flex items-center gap-2 mb-1">
                            <span :class="['text-xs font-bold px-2 py-0.5 rounded-full text-white', record.character === 'stitch' ? 'bg-stitch-blue' : 'bg-rose-400']">
                                {{ record.character === 'stitch' ? '史迪奇' : '大耳狗' }}
                            </span>
                        </div>
                        <div :class="['font-bold flex items-center', record.character === 'stitch' ? 'text-indigo-600' : 'text-rose-600']">
                            <i class="fa-solid fa-droplet mr-2"></i>經期
                        </div>
                        <div class="text-gray-700 mt-1">{{ record.startDate }} ~ {{ record.endDate }}</div>
                    </div>
                    <button @click="deleteItem('period', record.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <button @click="openModal('period')" class="fixed bottom-8 right-6 w-14 h-14 bg-rose-400 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-105 transition-transform z-50"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentTab === 'summary'" class="space-y-6">
            
            <div class="bg-sky-50 border border-sky-200 rounded-xl p-4">
                <div class="flex items-center justify-between mb-3 pb-2 border-b border-sky-200">
                    <div class="flex items-center gap-2">
                        <span class="bg-sky-400 text-white text-xs font-bold px-2 py-1 rounded-full">大耳狗</span>
                        <h3 class="font-bold text-gray-700">健康報告</h3>
                    </div>
                    <span class="text-xs text-gray-500">頭痛共 {{ getStats('cinnamoroll').totalDays }} 天</span>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div class="bg-white p-2 rounded text-center shadow-sm">
                        <div class="text-xs text-gray-400 mb-1">輕度</div>
                        <div class="text-lg font-bold text-blue-400">{{ getStats('cinnamoroll').level1Days }} <span class="text-xs font-normal text-gray-400">天</span></div>
                    </div>
                    <div class="bg-white p-2 rounded text-center shadow-sm">
                        <div class="text-xs text-gray-400 mb-1">中度</div>
                        <div class="text-lg font-bold text-yellow-500">{{ getStats('cinnamoroll').level2Days }} <span class="text-xs font-normal text-gray-400">天</span></div>
                    </div>
                    <div class="bg-white p-2 rounded text-center shadow-sm">
                        <div class="text-xs text-gray-400 mb-1">重度</div>
                        <div class="text-lg font-bold text-red-500">{{ getStats('cinnamoroll').level3Days }} <span class="text-xs font-normal text-gray-400">天</span></div>
                    </div>
                </div>

                <div class="bg-white/50 p-2 rounded text-sm text-gray-600 space-y-2">
                     <p><i class="fa-solid fa-pills mr-2 text-green-500"></i>投藥：{{ getStats('cinnamoroll').meds }} 次</p>
                     <p><i class="fa-solid fa-person-running mr-2 text-orange-400"></i>運動：{{ getStats('cinnamoroll').exerciseCount }} 次</p>
                     <p><i class="fa-solid fa-droplet mr-2 text-rose-400"></i>最近經期：{{ getStats('cinnamoroll').lastPeriod }}</p>
                </div>
            </div>

            <div class="bg-indigo-50 border border-indigo-200 rounded-xl p-4">
                <div class="flex items-center justify-between mb-3 pb-2 border-b border-indigo-200">
                    <div class="flex items-center gap-2">
                        <span class="bg-stitch-blue text-white text-xs font-bold px-2 py-1 rounded-full">史迪奇</span>
                        <h3 class="font-bold text-gray-700">健康報告</h3>
                    </div>
                    <span class="text-xs text-gray-500">頭痛共 {{ getStats('stitch').totalDays }} 天</span>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div class="bg-white p-2 rounded text-center shadow-sm">
                        <div class="text-xs text-gray-400 mb-1">輕度</div>
                        <div class="text-lg font-bold text-blue-400">{{ getStats('stitch').level1Days }} <span class="text-xs font-normal text-gray-400">天</span></div>
                    </div>
                    <div class="bg-white p-2 rounded text-center shadow-sm">
                        <div class="text-xs text-gray-400 mb-1">中度</div>
                        <div class="text-lg font-bold text-yellow-500">{{ getStats('stitch').level2Days }} <span class="text-xs font-normal text-gray-400">天</span></div>
                    </div>
                    <div class="bg-white p-2 rounded text-center shadow-sm">
                        <div class="text-xs text-gray-400 mb-1">重度</div>
                        <div class="text-lg font-bold text-red-500">{{ getStats('stitch').level3Days }} <span class="text-xs font-normal text-gray-400">天</span></div>
                    </div>
                </div>
                
                <div class="bg-white/50 p-2 rounded text-sm text-gray-600 space-y-2">
                     <p><i class="fa-solid fa-pills mr-2 text-green-500"></i>投藥：{{ getStats('stitch').meds }} 次</p>
                     <p><i class="fa-solid fa-person-running mr-2 text-indigo-400"></i>運動：{{ getStats('stitch').exerciseCount }} 次</p>
                     <p><i class="fa-solid fa-droplet mr-2 text-indigo-400"></i>最近經期：{{ getStats('stitch').lastPeriod }}</p>
                </div>
            </div>
            
            <button @click="clearAllData" class="w-full py-3 text-red-300 text-xs text-center hover:text-red-500">
                (開發用) 清除所有資料
            </button>
        </div>

    </main>

    <div v-if="isModalOpen" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            
            <div class="mb-5 flex gap-3 justify-center">
                <button @click="form.character = 'cinnamoroll'" 
                    :class="['char-btn flex-1 py-3 rounded-xl flex flex-col items-center gap-1 transition-all', form.character === 'cinnamoroll' ? 'active bg-sky-50 border-sky-400 text-sky-600' : 'bg-gray-50 border-transparent opacity-60']">
                    <span class="font-bold">大耳狗</span>
                </button>
                <button @click="form.character = 'stitch'" 
                    :class="['char-btn flex-1 py-3 rounded-xl flex flex-col items-center gap-1 transition-all', form.character === 'stitch' ? 'active bg-indigo-50 border-indigo-800 text-indigo-800' : 'bg-gray-50 border-transparent opacity-60']">
                    <span class="font-bold">史迪奇</span>
                </button>
            </div>

            <h3 class="text-xl font-bold text-gray-700 mb-4 text-center">{{ isEditing ? '編輯紀錄' : '新增紀錄' }}</h3>
            
            <div v-if="modalType === 'headache'" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                         <label class="block text-xs text-gray-500 mb-1">日期</label>
                         <input type="date" v-model="form.date" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm font-sans">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">時段</label>
                        <select v-model="form.period" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm">
                            <option value="早">早</option>
                            <option value="中">中</option>
                            <option value="晚">晚</option>
                            <option value="睡覺">睡覺</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">時間</label>
                        <input type="time" v-model="form.time" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">疼痛程度 (1-3)</label>
                    <div class="flex gap-2">
                        <button v-for="n in 3" :key="n" @click="form.intensity = n" 
                            :class="['flex-1 py-2 rounded border text-sm', form.intensity === n ? (n===3?'bg-red-500 text-white border-red-500':'bg-blue-500 text-white border-blue-500') : 'bg-white border-gray-200']">
                            {{ n }}
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">症狀</label>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center space-x-2"><input type="checkbox" value="對光敏感" v-model="form.symptoms"><span>對光敏感</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="對聲音敏感" v-model="form.symptoms"><span>對聲音敏感</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="單側開始" v-model="form.symptoms"><span>單側開始</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="搏動性" v-model="form.symptoms"><span>搏動性</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="噁心" v-model="form.symptoms"><span>噁心</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" value="嘔吐" v-model="form.symptoms"><span>嘔吐</span></label>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-100">
                    <label class="flex items-center space-x-2 mb-3 cursor-pointer">
                        <input type="checkbox" v-model="form.hasMeds" class="w-5 h-5 text-cinn-blue rounded border-gray-300">
                        <span class="font-bold text-gray-700">本次有服用藥物嗎？</span>
                    </label>
                    <div v-if="form.hasMeds" class="bg-green-50 p-3 rounded-lg border border-green-100 space-y-3">
                        <div>
                            <label class="block text-xs text-green-700 mb-1">藥物種類</label>
                            <div class="space-y-1 text-sm">
                                <label class="flex items-center space-x-2"><input type="checkbox" value="Imigran" v-model="form.medNames"><span>Imigran</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" value="Rizatan" v-model="form.medNames"><span>Rizatan</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" value="Diclofenac" v-model="form.medNames"><span>Diclofenac</span></label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-green-700 mb-1">時間</label>
                                <input type="time" v-model="form.medTime" class="w-full bg-white border border-green-200 rounded p-1 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-green-700 mb-1">效果</label>
                                <select v-model="form.medReaction" class="w-full bg-white border border-green-200 rounded p-1 text-sm">
                                    <option value="沒效">沒效</option>
                                    <option value="有效">有效</option>
                                    <option value="完全不痛">完全不痛</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="modalType === 'exercise'" class="space-y-3">
                 <div class="col-span-2">
                     <label class="block text-xs text-gray-500 mb-1">日期</label>
                     <input type="date" v-model="form.date" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm font-sans">
                </div>
                <div>
                    <label class="block text-sm text-gray-600">運動項目</label>
                    <input type="text" v-model="form.item" placeholder="例如：跑步 3km" class="w-full bg-gray-50 border border-gray-200 rounded p-2">
                </div>
                <div>
                    <label class="block text-sm text-gray-600">時間</label>
                    <input type="time" v-model="form.time" class="w-full bg-gray-50 border border-gray-200 rounded p-2">
                </div>
            </div>

            <div v-if="modalType === 'period'" class="space-y-3">
                <label class="block text-sm text-gray-600">開始日期</label>
                <input type="date" v-model="form.startDate" class="w-full bg-gray-50 border border-gray-200 rounded p-2">
                <label class="block text-sm text-gray-600">結束日期</label>
                <input type="date" v-model="form.endDate" class="w-full bg-gray-50 border border-gray-200 rounded p-2">
            </div>

            <div class="mt-8 flex gap-3">
                <button @click="isModalOpen = false" class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-500 hover:bg-gray-50">取消</button>
                <button @click="saveRecord" class="flex-1 py-3 rounded-xl bg-cinn-blue text-white shadow-md hover:bg-blue-600 font-bold">儲存</button>
            </div>
            
            <button v-if="isEditing" @click="deleteConfirm" class="w-full mt-3 py-2 text-red-400 text-sm hover:underline">刪除此紀錄</button>

        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, reactive, watch, onMounted } = Vue;

    createApp({
        setup() {
            const STORAGE_KEY = 'headache-diary-v4'; // 更新資料庫版本
            const currentTab = ref('headache');
            const isModalOpen = ref(false);
            const isEditing = ref(false);
            const modalType = ref('');
            const editingId = ref(null);

            const headacheRecords = ref([]);
            const exerciseRecords = ref([]);
            const periodRecords = ref([]);

            const form = reactive({
                character: 'cinnamoroll',
                date: '',
                period: '早', time: '', intensity: 1, symptoms: [],
                hasMeds: false, medNames: [], medTime: '', medReaction: '有效',
                item: '', startDate: '', endDate: ''
            });

            onMounted(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    headacheRecords.value = parsed.headache || [];
                    exerciseRecords.value = parsed.exercise || [];
                    periodRecords.value = parsed.period || [];
                }
            });

            const saveDataToStorage = () => {
                const data = {
                    headache: headacheRecords.value,
                    exercise: exerciseRecords.value,
                    period: periodRecords.value
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            };

            watch([headacheRecords, exerciseRecords, periodRecords], saveDataToStorage, { deep: true });

            const clearAllData = () => {
                if(confirm('確定要清空所有資料嗎？這無法復原喔！')) {
                    headacheRecords.value = [];
                    exerciseRecords.value = [];
                    periodRecords.value = [];
                    localStorage.removeItem(STORAGE_KEY);
                }
            };

            const getTabTitle = computed(() => {
                const titles = {
                    'headache': '頭痛紀錄',
                    'exercise': '運動紀錄',
                    'period': '生理期紀錄',
                    'summary': '雙人健康報表'
                };
                return titles[currentTab.value];
            });

            const sortByDate = (list) => {
                return [...list].sort((a, b) => {
                    const dateA = a.date || a.startDate;
                    const dateB = b.date || b.startDate;
                    return new Date(dateB) - new Date(dateA);
                });
            };

            const sortedHeadacheRecords = computed(() => sortByDate(headacheRecords.value));
            const sortedExerciseRecords = computed(() => sortByDate(exerciseRecords.value));
            const sortedPeriodRecords = computed(() => sortByDate(periodRecords.value));

            // *** 核心修改：統計邏輯 ***
            const getStats = (charName) => {
                // 1. 篩選出該角色的頭痛紀錄
                const hList = headacheRecords.value.filter(r => r.character === charName);
                
                // 2. 以「日期」為單位，計算每日最大疼痛值
                const dailyMaxPain = {}; // 用物件存這一天最痛是多少 { '2024-05-20': 3, '2024-05-21': 1 }
                
                hList.forEach(r => {
                    const d = r.date;
                    if (!d) return; // 防呆
                    
                    // 如果這一天還沒紀錄，或這筆紀錄比目前的紀錄更痛，就更新
                    if (!dailyMaxPain[d] || r.intensity > dailyMaxPain[d]) {
                        dailyMaxPain[d] = r.intensity;
                    }
                });

                // 3. 計算各等級的天數
                let level1Days = 0;
                let level2Days = 0;
                let level3Days = 0;
                
                Object.values(dailyMaxPain).forEach(intensity => {
                    if (intensity === 1) level1Days++;
                    if (intensity === 2) level2Days++;
                    if (intensity === 3) level3Days++;
                });

                // 4. 其他統計 (投藥次數仍算次數，不以天計，因為可能一天吃兩次藥)
                const meds = hList.filter(r => r.hasMeds).length;
                const eList = exerciseRecords.value.filter(r => r.character === charName);
                const pList = periodRecords.value.filter(r => r.character === charName);
                const sortedP = pList.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
                const lastPeriod = sortedP.length > 0 ? sortedP[0].startDate : '無紀錄';

                return {
                    totalDays: Object.keys(dailyMaxPain).length, // 總頭痛天數
                    level1Days,
                    level2Days,
                    level3Days,
                    meds,
                    exerciseCount: eList.length,
                    lastPeriod
                };
            };

            const resetForm = () => {
                const today = new Date().toISOString().split('T')[0];
                const nowTime = new Date().toTimeString().slice(0, 5);
                if (!form.character) form.character = 'cinnamoroll';
                form.date = today;
                form.period = '早'; 
                form.time = nowTime; 
                form.intensity = 1; 
                form.symptoms = [];
                form.hasMeds = false; form.medNames = []; form.medTime = nowTime; form.medReaction = '有效';
                form.item = '';
                form.startDate = today; form.endDate = today;
            };

            const openModal = (type) => {
                modalType.value = type;
                isEditing.value = false;
                editingId.value = null;
                resetForm();
                isModalOpen.value = true;
            };

            const editRecord = (type, record) => {
                modalType.value = type;
                isEditing.value = true;
                editingId.value = record.id;
                Object.assign(form, JSON.parse(JSON.stringify(record))); 
                isModalOpen.value = true;
            };

            const saveRecord = () => {
                const data = { ...form };
                let targetArray;
                if (modalType.value === 'headache') targetArray = headacheRecords;
                if (modalType.value === 'exercise') targetArray = exerciseRecords;
                if (modalType.value === 'period') targetArray = periodRecords;

                if (isEditing.value) {
                    const idx = targetArray.value.findIndex(r => r.id === editingId.value);
                    if (idx !== -1) targetArray.value[idx] = { ...targetArray.value[idx], ...data };
                } else {
                    data.id = Date.now();
                    targetArray.value.push(data);
                }
                isModalOpen.value = false;
            };

            const deleteConfirm = () => {
                if(confirm('確定要刪除這筆紀錄嗎？')) {
                    if (modalType.value === 'headache') headacheRecords.value = headacheRecords.value.filter(r => r.id !== editingId.value);
                    if (modalType.value === 'exercise') exerciseRecords.value = exerciseRecords.value.filter(r => r.id !== editingId.value);
                    if (modalType.value === 'period') periodRecords.value = periodRecords.value.filter(r => r.id !== editingId.value);
                    isModalOpen.value = false;
                }
            };

            const deleteItem = (type, id) => {
                if(!confirm('確認刪除？')) return;
                if (type === 'exercise') exerciseRecords.value = exerciseRecords.value.filter(r => r.id !== id);
                if (type === 'period') periodRecords.value = periodRecords.value.filter(r => r.id !== id);
            };

            return {
                currentTab, isModalOpen, isEditing, modalType, form,
                headacheRecords, exerciseRecords, periodRecords,
                getTabTitle, getStats, sortedHeadacheRecords, sortedExerciseRecords, sortedPeriodRecords,
                openModal, editRecord, saveRecord, deleteConfirm, deleteItem, clearAllData
            };
        }
    }).mount('#app');
</script>

</body>
</html>
